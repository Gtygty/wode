####JS和CSS懒加载

一般来讲，我们都是尽可能快的加载需要的资源。我们移除一些堵塞的请求来加快页面渲染，优化首屏，用浏览器缓存来处理重复的页面。


JS懒加载
========
设计上，我们的网站并没有很多JS。我们发展了一个JavaScript工作流来处理我们目前已有的js, 以及未来会用到的js资源。

JS在`<head>` 块里面渲染，这是我们想要的。JS应该只是用来提高用户体验，不应该是访问者需要的关键。处理JS堵塞渲染的简单方法就是把脚本放在页面的尾部。这样网页就会在整个HTML 渲染完毕后才去加载JS。

另一种可以把脚本放在 `head` 执行的方案是在 `<script>` 标签里面添加 `defer` 属性，来延迟脚本的执行。由于浏览器下载脚本是很快的，不会堵塞页面渲染进程，等到页面完全加载完，才会执行脚本里面的代码。还有一件事，我们没有使用像jQuery这些库，所以我们的脚本取决于 `vanilla` 脚本的特性。我们只是想要在浏览器加载脚本来支持这些特性。最终的结果就像下面的代码这样：

	<script>
	if ('querySelector' in document && 'addEventListener' in window) {
  	document.write('<script src="index.js" defer><\/	script>');
	}
	</script>
	
我们把这小段脚本放在页面头部，来检测浏览器是否支持原生`JavaScript`的 `document.querySelector` 和 `window.addEventListener `属性。如果支持，我们通过 `<script>` 标签直接给页面加载脚本，并使用 `defer` 属性让它不会堵塞页面渲染。

CSS懒加载
========
对于首屏来讲，网站最大的渲染堵塞资源就是CSS了。只有当 `<head>` 里面的CSS文件完全加载完毕时，浏览器才会开始渲染页面。这种做法是经过深思熟虑的，若不是这样，浏览器就需要在整个渲染过程中不断重新计算布局尺寸，不断重绘。

为了防止CSS堵塞渲染，我们就需要异步加载CSS文件。我们使用了 `Filament Group` 的 `awesome loadCSS` 函数。该函数提供了一个回调，当CSS文件加载完后，我们设置一个cookie来声明CSS文件已经加载了。我们使用这个cookie来重现页面，这一点我后续会解释到。

CSS异步加载也带来这样一个问题，尽管 HTML 真的很快被渲染出来，但看起来就只有纯粹的HTML，只有等到整个CSS文件加载完且停止时，才会有样式。这时就要提到`关键CSS`了。


关键CSS
========

关键CSS就是阻塞浏览器渲染出用户可识别的网页的一小部分CSS。我们注意网页的 `上半版版面`。很明显，两个设备的版面的位置有很大的区别。因此，我们做了一个大胆的猜测。

手动地检测这部分关键性的CSS是个很耗时的过程，尤其是样式、特性等不断改变时。这里有几个好的脚本，可以在你构建网页时，生成关键性CSS。我们采用了` Addy Osmani `的版本。